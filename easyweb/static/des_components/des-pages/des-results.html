<dom-module id="des-results">
<template>
    <style include="shared-styles">
    paper-dialog {
        height: 60%;
        width: 70%;
        overflow-y: scroll;
    }
    iron-list {
        height: 100%;
    }
    </style>

    <iron-ajax id="getTiles"
               auto
               url=/easyweb/static/workdir/{{username}}/{{jobid}}/list.json
               handle-as="json"
               last-response="{{jsondata}}"
               on-response="_getTilesResponse">
    </iron-ajax>



    <iron-ajax id="getLogHelp"
               url="/easyweb/mylogs/"
               method="POST"
               handle-as="json"
               content-type="application/x-www-form-urlencoded"
               last-response="{{logdata}}"
               debounce-duration="300">
    </iron-ajax>


    <!--<paper-dialog class="dialog-position" id="jobHelpResults" with-backdrop on-iron-overlay-opened="patchOverlay">-->
        <!--<p>Help goes here</p>-->
    <!--</paper-dialog>-->




    <paper-dialog id="logDialogHelp" with-backdrop modal on-iron-overlay-opened="patchOverlay">
        <h2>Log</h2>
                   Job : {{jobid}}
                   <br>
                   <des-html html={{logdata}}></des-html>
       <div class="buttons">
           <paper-button  class="indigo" raise autofocus on-tap="_gobackdialog" >Dismiss</paper-button>
       </div>

    </paper-dialog>


    <des-card heading="Job [ [[jobname]] ]: [[jobid]] ( [[jsondata.length]] images)">
        <!--<br>-->
        <!--<b>Comment:</b> {{jobcomment}}-->
        <paper-button class="custom indigo" on-tap="_seeLog"> See Log</paper-button>
        <paper-button class="custom indigo" on-tap="_getAll"> Download All(tar file)</paper-button>
        <paper-button class="custom indigo" on-tap="_getList"> See Files</paper-button>
        <paper-button class="custom indigo" on-tap="_closedialog"> Close</paper-button>
        <hr class="des-hr">
    <!--<div class="card-content" style="height: 70%; overflow-y: scroll;">-->
    <div class="card-content" style="height: 70%; overflow-y: scroll;">

    <template is="dom-if" if="{{_actionIsFC(jobtype)}}" restamp>
    <template is="dom-if" if="{{jsondata}}">
        <template is="dom-repeat" items="{{jsondata}}">
            <des-thumb imtitle={{item.title}} imdisplay={{item.name}} jobid="[[jobid]]">
            </des-thumb>
        </template>
    </template>
    </template>

    <template is="dom-if" if="{{_actionIsDA(jobtype)}}" restamp>
    <template is="dom-if" if="{{jsondata}}">
        <template is="dom-repeat" items="{{jsondata}}">
            <des-thumb imtitle={{item.title}} imdisplay={{item.name}} jobid="[[jobid]]">
            </des-thumb>
        </template>
    </template>
    </template>

    <template is="dom-if" if="{{_actionIsCoadd(jobtype)}}" restamp>
    <template is="dom-if" if="{{jsondata}}" restamp>
        <!--<template is="dom-repeat" items="{{jsondata}}" initial-count="20" target-framerate="60">
            <des-thumb imtitle={{item.title}} imdisplay={{item.name}} jobid="[[jobid]]">
            </des-thumb>
        </template>-->
        <template is="dom-if" if="{{!_checkLength(jsondata)}}" restamp>
            <h3> Too many thumbnails to load here!</h3>
            <!--<iron-ajax id="getTileList"
               auto
               url=/easyweb/static/workdir/{{username}}/{{jobid}}/list_all.txt
               handle-as="text"
               last-response="{{textdata}}"
               on-response="_getTextResponse">
            </iron-ajax>-->
            <p>Check the file "<a href="/easyweb/static/workdir/{{username}}/{{jobid}}/list_all.txt" target="_blank">list_all.txt</a>" for image URLs.</p>
        </template>
        <template is="dom-if" if="{{_checkLength(jsondata)}}" restamp>
            <template is="dom-repeat" items="{{jsondata}}" initial-count="20" target-framerate="60">
                <des-thumb imtitle={{item.title}} imdisplay={{item.name}} jobid="[[jobid]]">
                </des-thumb>
            </template>
        </template>
        <!--<iron-list items="{{jsondata}}" as="item" grid>
            <template>
                    <des-thumb imtitle={{item.title}} imdisplay={{item.name}} jobid="[[jobid]]" style="z-index:[[_getIndex(index)]];"></des-thumb>
            </template>
        </iron-list>-->
    </template>
    </template>

    <template is="dom-if" if="{{_actionIsSE(jobtype)}}" restamp>
    <template is="dom-if" if="{{jsondata}}">
        <template is="dom-repeat" items="{{jsondata}}">
            <des-thumb imtitle={{item.title}} imdisplay={{item.name}} jobid="[[jobid]]">
            </des-thumb>
        </template>
    </template>
    </template>

    <!--
    <template is="dom-if" if="{{_actionIsSE(jobtype)}}">
    <template id="inside" is="dom-if" if="{{jsondata}}">
        <template id="seRepeat" is="dom-repeat" items="{{jsondata}}">
            <des-thumb-epoch imdisplay="[[item.demo_png]]" imtitle="[[item.image_title]]" username="{{username}}" ra="[[item.RA]]" dec="[[item.DEC]]" jobid="[[jobid]]"></des-thumb-epoch>
        </template>
    </template>
    </template>
    -->

    </div>


    <template is="dom-if" if="{{!jsondata}}">
         <h3> There are no outputs for this job. Check logfile for details.</h3>
    </template>

    <paper-toast class="toast-position toast-error" id="da_toastresults" text="No archive file was created for this job." duration="5000"> </paper-toast>

    </des-card>
    <!--<paper-fab icon="help" on-tap="_seeHelp" style="float: right;"></paper-fab>-->


</template>

<script>
    Polymer({
        is: "des-results",
        properties : {
            jsondata: {
                type: Array,
            },
//            textdata: {
//                value: '',
//                type: Array,
//            },
            jobid: {
                value : '',
                type : String,
                notify: true,
            },
            jobname: {
                value : '',
                type : String,
                notify: true,
            },
            username:{
                type: String,
                value: '',
            },
            jobtype: {
                value : '',
                type : String,
                notify: true,
            },
        },

        _actionIsFC: function(job_type) {
            if (job_type == "finding chart") {
                console.log("Finding Chart!")
                return true;
            }
        },
        _actionIsDA: function(job_type) {
            if (job_type == "data analysis") {
                console.log("Data Analysis!")
                return true;
            }
        },
        _actionIsCoadd: function(job_type) {
            if (job_type == "coadd") {
                console.log("COADD!")
                return true;
            }
        },
        _actionIsSE: function(job_type) {
            if (job_type == "epoch") {
                console.log("EPOCH!")
                return true;
            }
        },
        _seeLog: function(e) {
            e.stopPropagation();
            console.log('Log!');
            logform = document.getElementById('getLogHelp');
            logform.body = {
                  'jobid': this.jobid,
            };
            logform.generateRequest();
            document.getElementById('logDialogHelp').open();
        },
        _getList: function(){
            var siid = this.jobid;
            var user = this.username;
            var url = "/easyweb/static/workdir/"+user+"/"+siid+"/list_all.txt"
            window.open(url,'_blank');
        },
        _getAll: function(){
            var link = document.createElement('a');
            var siid = this.jobid;
            var user = this.username;
            link.href = "/easyweb/static/workdir/"+user+"/"+siid+"/"+siid+".tar.gz";
            if (this._checkLength(this.jsondata)) {
                if (link.download !== undefined){
                    //Set HTML5 download attribute. This will prevent file from opening if supported.
                    var fileName = link.href.substring(link.href.lastIndexOf('/') + 1, link.href.length);
                    link.download = fileName;
                }
                if (document.createEvent) {
                    var e = document.createEvent('MouseEvents');
                    e.initEvent('click' ,true ,true);
                    link.dispatchEvent(e);
                    return true;
                }
                var query = '?download';
                window.open(link.href + query);
            }
            else {
                document.querySelector('#da_toastresults').show();
            }
        },
        _gobackdialog: function(event){
            document.getElementById('logDialogHelp').close();
            document.getElementById('JobTiles').close();
            document.getElementById('JobTiles').open();
        },
        _closedialog: function(event){
            document.getElementById('JobTiles').close();
        },
        patchOverlay: function (e) {
            if (e.target.withBackdrop) {
                e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
            }
        },
        _checkLength: function(data) {
            if (data.length > 300) {
                console.log('> 300');
                return false;
            }
            else {
                console.log('<= 300');
                return true;
            }
        },
        _getIndex: function(itemIndex) {
            return this.jsondata.length-itemIndex;
        },
        _getTilesResponse: function() {
            console.log(this.jsondata);
            if (this.jsondata.length == 0 ) {
              //document.getElementById('getAllIcon').disabled=true;
              console.log('==0');
            }
            else {
              console.log('!=0');
              //document.getElementById('getAllIcon').disabled=false;
            }
        },
        _getTextResponse: function() {
            console.log(this.textdata);
        },
//        patchOverlay: function (e) {
//            if (e.target.withBackdrop) {
//                e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
//            }
//        },
//        _seeHelp: function(e){
//            e.preventDefault();
//            document.getElementById('jobHelpResults').open();
//        },
    });
</script>
</dom-module>
