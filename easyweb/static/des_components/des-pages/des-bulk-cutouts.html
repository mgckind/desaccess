<dom-module id="des-bulk-cutouts">
    <style include="shared-styles">
        .caption {
            padding-left: 15px;
            color: #a0a0a0;
        }
        .upload{
            position: absolute;
            opacity: 0;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            /*border: 2px dotted #8da6ce;*/
            /*border-style: outset;*/
        }
        .card-content {
            @apply(--layout-vertical);
        }
        .coadd-container {
            margin-top: 10px;
            @apply(--layout-horizontal);
        }
        .container2 {
            @apply(--layout-horizontal);
            @apply(--layout-center-justified);
        }
        .container3 {
            @apply(--layout-horizontal);
            @apply(--layout-around-justified);
        }

        .left {
            @apply(--layout-flex);
        }
        .left2 {
            @apply(--layout-flex);
            text-align: center;

        }
        .right {
            @apply(--layout-flex);
        }
        .right2 {
            @apply(--layout-flex-2);
            text-align: center;

        }

        .mid {
            @apply(--layout-flex);
        }
        .flex3child {
            @apply(--layout-flex-3);
        }
        .flex4child {
            @apply(--layout-flex-4);
        }

        paper-slider {
            width: 100%;
        }

        hr {
            display: block;
            border: 1px solid gray;
            opacity: 0.2;

        }

        paper-icon-item {
            /*background: linear-gradient(to right, #efeaf4, white);*/
        }

        .buttonLook{
            border: 4px solid #ccc;
            border-style: outset;
            border-radius: 10px;
        }
        .btcell {
            text-align: center;
        }

        .around-cell {
            @apply(--layout-horizontal);
            @apply(--layout-around-justified);
        }

        .around-cell2 {
            @apply(--layout-horizontal);
            @apply(--layout-center-justified);
        }


    </style>
    <template>
        <paper-dialog class="dialog-position" id="jobHelpBulkCutouts" with-backdrop on-iron-overlay-opened="patchOverlay">
            <des-card heading="Help: Bulk Cutouts Form">
                <div class="card-content">
                    <paper-carousel id="coadd-crs" items="1" dotText="false" controls="true">
                        <div style="text-align: left;">
                            <p>This form allows you to generate cutouts on the order of up to 10^6 objects.</p>
                            <p>You can upload a CSV file with either CoaddIDs or RA/DEC positions or you can enter a list of either manually.</p>
                            <p>Use the "xsize" and "ysize" sliders to define the field of view (in arcminutes) around these positions. The field is centered on the object or RA/DEC coordinates you enter.</p>
                            <p>The "TIFF" option lets you generate 8-bit-per-channel RGB images with the TIFF file extension. This option generates a cutout from a pre-generated master file.</p>
                            <p>The "PNG" option lets you generate 8-bit-per-channel RGB images with the PNG file extension. This option generates a cutout from a pre-generated master file.</p>
                            <p>The "FITS" option lets you generate 8-bit FITS images for each color band you select.</p>
                            <p>The "Generate RGB" option lets you generate PNG images using the color bands you input.</p>
                            <p>You can specify a name for this job under "Job Name."</p>
                            <p>You can have the server email-notify you when your job has been completed.</p>
                            <p>Under "Return Options" you have the option to retrieve the table of matching values between your input objects/coordinates and the survey tiles they are found in.</p>
                            <p>Check the <b>My Jobs</b> tab to see the status of your jobs.</p>
                        </div>
                    </paper-carousel>
                </div>
                <!--<div class="row">
                    <paper-button class="prev" on-tap="_prevPage">
                        <iron-icon icon="image:navigate-before"></iron-icon>
                        Prev
                    </paper-button>

                    <paper-button class="next" on-tap="_nextPage">
                        Next
                        <iron-icon icon="image:navigate-next"></iron-icon>
                    </paper-button>
                </div>-->

            </des-card>
        </paper-dialog>
        <section>
            <des-card heading = "Bulk Cutouts Form" >
                <div class="card-content">
                    <!--<div class="top">
                        Upload a file with CoaddIDs or RA/DEC positions, or enter them manually and run the cutout generator
                    </div>-->

                    <table id="coadd-table" style="width:100%">

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="backup" slot="item-icon"></iron-icon>
                                    <iron-icon icon="hardware:keyboard" slot="item-icon"></iron-icon>
                                    <span style="overflow-x:auto; overflow-wrap:break-word;">Upload csv file (with header). <br />Or enter values manually (with header).</span>
                                </paper-icon-item>
                            </td>
                            <td class="btcell">
                                <div class="around-cell">
                                    <paper-button raised class="indigo" id="bc_uploadFile">
                                        <div id="bc_uploadicon" style="display: inline-block;">
                                            <i class="fa fa-cloud-upload"></i>
                                            &nbsp;  &nbsp;
                                        </div>
                                        <span style="overflow-x: auto; overflow-wrap: break-word;">
                                            [[file_name]]
                                        </span>
                                        <input type="file" class="upload" id="filesAB" on-change="_fileChange" />
                                    </paper-button>
                                    <paper-button raised class="indigo" id="bc_enterManually" on-tap="_bc_openManualEntry">
                                        <div id ="bc_keyboardicon" style="display: inline-block;">
                                            <i class="fa fa-keyboard-o"></i>
                                            &nbsp;  &nbsp;
                                        </div>
                                        <span>[[enter_values]]</span>
                                    </paper-button>
                                </div>
                            </td>
                        </tr>

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="check" slot="item-icon"></iron-icon>
                                    Generate color png or just FITS cutouts &nbsp; <span style="color:red"> (required)</span>
                                </paper-icon-item>
                            </td>
                            <td class="coadd-td">
                                <div class="around-cell">
                                    <div class="left">
                                        <paper-checkbox style="font-size:16px; padding-top:15px;" id="bc_tiffs">Stiff_RGB</paper-checkbox>
		                        <iron-icon icon="icons:create" style="height: 15px; width: 15px; color: #666666;" on-click="rgboptions"></iron-icon>
                                    </div>
                                    <div class="left">
                                        <paper-checkbox style="font-size:16px; padding-top:15px;" id="bc_pngs">Lupton_RGB</paper-checkbox>
		                        <iron-icon icon="icons:create" style="height: 15px; width: 15px; color: #666666;" on-click="rgboptions"></iron-icon>
                                    </div>
                                    <div class="left">
                                        <paper-checkbox style="font-size:16px; padding-top:15px;" id="bc_fits" on-change="fitsoptions"> Just FITS</paper-checkbox>
		                        <iron-icon icon="icons:create" style="height: 15px; width: 15px; color: #666666;" on-click="fitsoptions"></iron-icon>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="image:tune" slot="item-icon"></iron-icon>
                                    <div>Xsize (in arcminutes):
                                        <span id="bc_xsizeLabel" class="caption">1.0</span></div>
                                </paper-icon-item>
                            </td>
                            <td class="coadd-td">
                                <paper-slider id="bc_xsizeSlider" pin max="12" max-markers="10" step="0.1" value="1.0" expand editable></paper-slider>
                            </td>
                        </tr>

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="image:tune" slot="item-icon"></iron-icon>
                                    <div>Ysize (in arcminutes):
                                        <span id="bc_ysizeLabel" class="caption">1.0</span></div>
                                </paper-icon-item>
                            </td>
                            <td class="coadd-td">
                                <paper-slider id="bc_ysizeSlider" pin  max="12" max-markers="10" step="0.1" value="1.0" expand editable></paper-slider>
                            </td>
                        </tr>

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="create" slot="item-icon"></iron-icon>
                                    Job Name
                                </paper-icon-item>
                            </td>
                            <td class="coadd-td">
                                <paper-input always-float-label id="bc_validname" name="name" label="Job Name" value="" style = "max-width: 500px;"></paper-input>
                            </td>
                        </tr>

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="mail" slot="item-icon"></iron-icon>
                                    Email Options
                                </paper-icon-item>
                            </td>
                            <td class="coadd-td">
                                <div class="around-cell">
                                    <div class="left">
                                        <paper-checkbox style="font-size:16px; padding-top:25px;" id="bc_sendemail" on-change="emailcheck">Send email on completion</paper-checkbox>
                                    </div>
                                    <div class="right">
                                        <paper-input always-float-label id="bc_validemail" name="email" label="Email" value="" ></paper-input>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="save" slot="item-icon"></iron-icon>
                                    Return Options
                                </paper-icon-item>
                            </td>
                            <td class="coadd-td">
                                <paper-checkbox style="font-size:16px;" id="bc_returnList">Include CSV of tiles matched to objects</paper-checkbox>
                            </td>
                        </tr>
                    </table>
                    <div class="coadd-container">
                        <div class="left">
                            <paper-button raised class="indigo"  id="clearFormButton" on-tap="_clearForm">
                            <i class="fa fa-cogs"></i> &nbsp;  &nbsp;Clear Form
                            </paper-button>
                            </div>
                        <div class="right">
                            <paper-button raised  class="indigo"  id="bc_submitJobButton" disabled on-tap="_submitJob">
                            <i class="fa fa-cogs"></i> &nbsp;  &nbsp;Submit Job
                            </paper-button>
                        </div>
                    </div>
                </div>
            </des-card>

            <des-positions-bc id="desPositionsBC"></des-positions-bc>
            <!--
            <des-positions-coadds-bc id="desPositionsCoaddsBC"></des-positions-coadds-bc>
            <des-positions-coords-bc id="desPositionsCoordsBC"></des-positions-coords-bc>
            -->

            <paper-toast class="toast-position toast-success" id="bc_toast1coadd" text="Job has been submitted!" duration="6000"> </paper-toast>
            <paper-toast class="toast-position toast-error" id="bc_toast2coadd" text="ERROR!. There was an error. Please try again" duration="6000"> </paper-toast>
            <paper-toast class="toast-position toast-error" id="bc_toast3coadd" text="Form is incomplete for selected options!" duration="6000"> </paper-toast>

            <paper-dialog class="size-position2" id="bc_emaildialog" with-backdrop on-iron-overlay-opened="patchOverlay">
                <paper-card elevation="0">
                    <div class="card-content">
                        Please verify email address
                    </div>
                </paper-card>
            </paper-dialog>
            <paper-dialog id="bc_rgbbandsDialog" with-backdrop on-iron-overlay-opened="patchOverlay">
                <paper-card elevation="0">
                    <div class="card-content">
                        Please enter RGB Bands to create color cutouts, e.g.: i,r,g
                          <div class="right">
                              <paper-input always-float-label id="bc_rgb_values" name="rgbbands" label="RGB Bands" value="i,r,g"></paper-input>
                          </div>
                      <div class="card-actions">
                        <paper-button dialog-dismiss autofocus raised class="indigo">Close</paper-button>
                    </div>
                    </div>
                </paper-card>
            </paper-dialog>
            <paper-dialog style="width: 40%;" id="bc_fitsOptionsDialog" with-backdrop on-iron-overlay-opened="patchOverlay" >
                <paper-card heading= "Select bands" elevation="0" >
                    <div class="card-content">
                                <div class="around-cell">
                                    <paper-checkbox class="bandbox" style="font-size:16px; padding-top:15px;" id="bc_gband">g</paper-checkbox>
                                    &nbsp;
                                    &nbsp;
                                    <paper-checkbox class="bandbox" style="font-size:16px; padding-top:15px;" id="bc_rband">r</paper-checkbox>
                                    &nbsp;
                                    &nbsp;
                                    <paper-checkbox class="bandbox" style="font-size:16px; padding-top:15px;" id="bc_iband">i</paper-checkbox>
                                    &nbsp;
                                    &nbsp;
                                    <paper-checkbox class="bandbox" style="font-size:16px; padding-top:15px;" id="bc_zband">z</paper-checkbox>
                                    &nbsp;
                                    &nbsp;
                                    <paper-checkbox class="bandbox" style="font-size:16px; padding-top:15px;" id="bc_Yband">Y</paper-checkbox>
                                    &nbsp;
                                    &nbsp;
                                    <paper-toggle-button style="font-size:16px; padding-top:15px;" id="bc_all_toggle" on-change="toggle_all_bands">Select All</paper-toggle-button>
                                    &nbsp;
                                    <br />
                    </div>
                                    <br />
                    <div class="card-actions">
                        <paper-button dialog-dismiss autofocus raised class="indigo">Close</paper-button>
                    </div>
                </paper-card>
            </paper-dialog>
        </section>
        <paper-fab  class="fabHelp" icon="help" title="Help" on-tap="_seeHelp" style="float: right;"></paper-fab>

    </template>

</dom-module>

<script>
    Polymer({
        is: "des-bulk-cutouts",
        properties: {
            file_name: {
                type : String,
                value : "Upload File"
            },
            enter_values: {
                type : String,
                value : "Enter Values"
            },
            submit_type: {
                type: String,
                value: "csvfile"
            },
            email: {
                type: String,
                values: ""
            },
            job_comment: {
                type : String,
                value : ""
            }
        },
        ready: function () {
            var bc_all_toggle = this.$.bc_all_toggle;
            bc_all_toggle.addEventListener('change', function () {
                document.getElementById('desBulkCutouts').toggle_bands();
            });
        },
        toggle_bands: function () {
            var band_rads = document.querySelectorAll('.bandbox');
            if (this.$.bc_all_toggle.checked) {
                for (var j=0; j<5; j++) {
                    band_rads[j].disabled=true;
                }
            }
            else {
                for (var i=0; i<5; i++) {
                    band_rads[i].disabled=false;
                }
            }
        },
        toggle_all_bands: function () {
            var band_rads = document.querySelectorAll('.bandbox');
            if (this.$.bc_all_toggle.checked) {
                for (var j=0; j<5; j++) {
                    band_rads[j].checked=true;
                }
            }
            else {
                for (var i=0; i<5; i++) {
                    band_rads[i].checked=false;
                }
            }
        },

        get filesAB(){
            return this.$.filesAB.files[0];
        },
        /*
        get file1(){
            return this.$.file1.files[0];
        },
        get file2(){
            return this.$.file2.files[0];
        },
        */
        emailcheck: function () {
            var emailbox = document.getElementById("bc_sendemail");
            var edialog = document.getElementById("bc_emaildialog");
            document.getElementById("bc_validemail").value=this.email;
            if (emailbox.checked == true) {
                //edialog.open();
            }
            else {
                document.getElementById("bc_validemail").value='';
            }
        },
        fitsoptions: function (e) {
            e.preventDefault();
            if (document.getElementById("bc_fits").checked) {
            document.getElementById('bc_fitsOptionsDialog').open();
            }
        },
        rgboptions: function (e) {
            e.preventDefault();
            document.getElementById('bc_rgbbandsDialog').open();
        },
        _fileChange: function () {
            this.file_name = this.filesAB.name;
            console.log('File to read: ' + this.file_name);
            document.getElementById("bc_submitJobButton").disabled=false;
            document.getElementById("bc_enterManually").disabled=true;
            document.getElementById("bc_uploadicon").icon = "done";

            this.submit_type = 'csvfileAB';
        },
        clear: function () {
            document.getElementById("bc_submitJobButton").disabled=true;
            document.getElementById("bc_enterManually").disabled=false;
            document.getElementById("bc_uploadFile").disabled=false;
            document.getElementById("bc_keyboardicon").style.display="inline-block";
            document.getElementById("bc_tiffs").checked=false;
            document.getElementById("bc_pngs").checked=false;
            document.getElementById("bc_fits").checked=false;
            document.getElementById("bc_xsizeSlider").value="1.0";
            document.getElementById("bc_ysizeSlider").value="1.0";
            document.getElementById("bc_xsizeLabel").innerHTML="1.0";
            document.getElementById("bc_ysizeLabel").innerHTML="1.0";
            document.getElementById("bc_all_toggle").checked=false;

            var band_rads = document.querySelectorAll('.bandbox');
            for (var j=0; j<5; j++) {
                band_rads[j].checked=false;
                band_rads[j].disabled=false;
            }

            document.getElementById("bc_gband").checked=false;
            document.getElementById("bc_rband").checked=false;
            document.getElementById("bc_iband").checked=false;
            document.getElementById("bc_zband").checked=false;
            document.getElementById("bc_Yband").checked=false;
            document.getElementById("bc_sendemail").checked=false;
            document.getElementById("bc_returnList").checked=false;
            document.getElementById("desPositionsBC").clear();
            document.getElementById("bc_rgb_values").value='i,r,g';
            document.getElementById("bc_validemail").value='';
            document.getElementById("bc_validname").value='';
            document.getElementById("bc_uploadicon").icon = "backup";
            document.getElementById("bc_keyboardicon").icon = "hardware:keyboard";
            this.file_name = "Upload File";
            this.job_comment = "";

            var upIcon = document.getElementById("bc_uploadicon").style.display="inline-block";
            /*
            var upIcon1 = document.getElementById("bc_uploadiconcoadd").style.display='inline-block';
            var upIcon2 = document.getElementById("bc_uploadiconcoord").style.display='inline-block';
            */
            this.enter_values = "Enter Values";
            this.$.filesAB.value = "";
            /*
            this.$.file1.value = "";
            this.$.file2.value = "";
            */
        },
        /*
        _countCoadds: function(coadds) {
            console.log(coadds);
        },
        _countCoords: function(coords) {
            console.log(coords);
        },
        */

        _bc_openManualEntry: function () {
            var inputDialog = document.getElementById("bc_inputDialog");
            inputDialog.open();
            this.submit_type = 'manualAB';
        },
        completeHandler: function () {
            document.getElementById('desBulkCutouts').clear();
            document.querySelector('#bc_toast1coadd').show();
            document.getElementById("getMyJobs").generateRequest();
        },
        errorHandler: function (data) {
            var response = data.responseJSON;
            // document.getElementById('desBulkCutouts').clear();
            document.querySelector('#bc_toast2coadd').text = response.msg;
            document.querySelector('#bc_toast2coadd').show();
        },
        errorHandler2: function () {
            document.querySelector('#bc_toast3coadd').show();
        },
        _submitJob: function (event) {
            var formdata = new FormData();
            formdata.append('csvfile', this.$.filesAB.files[0]);
            /*
            formdata.append('csvfile1', this.$.file1.files[0]);
            formdata.append('csvfile2', this.$.file2.files[0]);
            */

            formdata.append('make_tiffs', document.getElementById("bc_tiffs").checked);
            formdata.append('make_pngs', document.getElementById("bc_pngs").checked);
            formdata.append('make_fits', document.getElementById("bc_fits").checked);
            formdata.append('rgb_values', document.getElementById("bc_rgb_values").value);

            formdata.append('bc_xsize', document.getElementById("bc_xsizeSlider").value);
            formdata.append('bc_ysize', document.getElementById("bc_ysizeSlider").value);

            formdata.append('bc_gband', document.getElementById("bc_gband").checked);
            formdata.append('bc_rband', document.getElementById("bc_rband").checked);
            formdata.append('bc_iband', document.getElementById("bc_iband").checked);
            formdata.append('bc_zband', document.getElementById("bc_zband").checked);
            formdata.append('bc_Yband', document.getElementById("bc_Yband").checked);
            formdata.append('bc_all_toggle', document.getElementById("bc_all_toggle").checked);

            formdata.append('bc_returnList', document.getElementById("bc_returnList").checked);
            formdata.append('bc_send_email', document.getElementById("bc_sendemail").checked);
            formdata.append('bc_email', document.getElementById("bc_validemail").value);
            formdata.append('bc_name', document.getElementById("bc_validname").value);
            formdata.append('bc_submit_type', this.submit_type);

            formdata.append('bc_positions',document.getElementById("bc_enteredPositions").value);

            var tiffs = document.getElementById("bc_tiffs").checked;
            var pngs = document.getElementById("bc_pngs").checked;
            var fits = document.getElementById("bc_fits").checked;
            var rgb_val = document.getElementById("bc_rgb_values").value;
            var g = document.getElementById("bc_gband").checked;
            var r = document.getElementById("bc_rband").checked;
            var i = document.getElementById("bc_iband").checked;
            var z = document.getElementById("bc_zband").checked;
            var y = document.getElementById("bc_Yband").checked;
            var allbands = document.getElementById("bc_all_toggle").checked;
            fits = true;
            g = true;
            if (tiffs == false && pngs == false && fits == false) {
                document.getElementById('desBulkCutouts').errorHandler2();
            }
            else if (fits == true && (g == false && r == false && i == false && z == false && y == false && allbands == false)) {
                document.getElementById('desBulkCutouts').errorHandler2();
            }
            else {
                $.ajax({
                    url: '/easyweb/bulk_cutout/',
                    type: 'POST',
                    //beforeSend: this.beforeSendHandler,
                    success: this.completeHandler,
                    error: this.errorHandler,
                    data: formdata,
                    cache: false,
                    contentType: false,
                    processData: false
                });
            }
        },
        _clearForm: function () {
            console.log('clear Form');
            desBulkCutouts=document.getElementById('desBulkCutouts');
            desBulkCutouts.clear();
        },
        patchOverlay: function (e) {
            if (e.target.withBackdrop) {
                e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
            }
        },
        _seeHelp: function (e) {
            e.preventDefault();
            document.getElementById('jobHelpBulkCutouts').open();
        },


        _nextPage: function () {
            var crs = document.getElementById("coadd-crs");
            crs.goToNextPage();
        },

        _prevPage: function () {
            var crs = document.getElementById("coadd-crs");
            crs.goToPrevPage();
        },

    });
</script>
