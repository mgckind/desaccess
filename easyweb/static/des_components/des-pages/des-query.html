<link rel="import" href="../../styles/shared-styles.html">
<dom-module id="des-query">
<template>
<style include="shared-styles"></style>

<iron-ajax id="getQuery"
   url="/easyweb/query/"
   method="POST"
   contentType="application/json"
   params='{{_getQuery(querystr,querykind,outputfile, queryname)}}'
   handle-as="json"
   on-response="_complete"
   on-request="_request"
   on-error="_error"
   debounce-duration="300">
</iron-ajax>

<iron-ajax id="getMyResponse"
   url="/easyweb/myresponse/"
   method="POST"
   contentType="application/json"
   params='{{_getJobid(jobid)}}'
   handle-as="json"
   on-response="_complete"
   debounce-duration="300">
</iron-ajax>
    <des-card heading=" Query box">
    <div class="content">
    Insert your query in the box below. Prelimary data results will be displayed below "Output File".
    </div>
    </des-card>
<div class="query-box" style="padding-right:20px">
    <paper-dialog class="dialog-position" id="jobHelpQuery" with-backdrop on-iron-overlay-opened="patchOverlay">
        <p>Help goes here</p>
    </paper-dialog>
<!--
<paper-textarea id = "queryBox"  label="Query box" always-float-label required error-message="needs some text!" placeholder="Input query"  rows=10 maxRows=20>
</paper-textarea>-->
<textarea id="queryBox" autofocus placeholder="Query box"></textarea>
<br>
<paper-button id="subQuery" class="indigo" raised disabled on-tap="_submitQuery">Submit Job</paper-button>
<paper-button class="indigo" raised on-tap="clearQueryBox">Clear</paper-button>
<paper-button class="indigo" raised on-tap="_checkSyntax">Check</paper-button>
<paper-button class="indigo" raised on-tap="_quickSubmit">Quick</paper-button>
<paper-spinner id="querySpinner" class="big"></paper-spinner>
<br>
<br>
<div class="container3">

    <paper-input  id="queryname" name="name" label="Query Name" value=""></paper-input>
    <paper-toggle-button class="queryButton" id="inputOutputCheck" noink on-tap="_enableOutputFile"> Output file
    </paper-toggle-button>
    <paper-input id="inputOutputFile" disabled required auto-validate label="Output file" value="output.csv"></paper-input>

</div>
<hr /><br>
<div id="response" class="results">
<template is="dom-if" if={{isQuery}} >
    <template is="dom-if" if={{isOk}} >
        <span class="queryMsg" style="color: green"> {{msg}}</span>
    </template>
    <template is="dom-if" if={{!isOk}} >
        <span class="queryMsg" style="color: red"> {{msg}}</span>
    </template>
</template>
<template is="dom-if" if={{isSelect}} >
    <div class="scrollTable">
<table id="t01" style="width:100%">
    <tr>
    <th>
        {{idx}}
    </th>
    <template is="dom-repeat" items="{{keys}}" as="key">
        <th>&nbsp;{{key}}&nbsp;</th>
    </template>
    </tr>
<!--</table>-->

    <!--<table id="t01" style="width:100%">-->
        <template is="dom-repeat" id="pandas" items="{{mydata}}">
            <tr>
                <td>
                {{index}}
                </td>
                <template is="dom-repeat" items="{{keys}}" as="key">
                    <td>{{_returnVal(item,key)}}</td>
                </template>
            </tr>
        </template>
    </table>
</div>


</template>
</div>

<paper-toast class="toast-position" id="toast1" text="Job has been submitted!" duration="5000"> </paper-toast>
<paper-toast class="toast-position" id="toast2" text="ERROR!. There was an error. Please try again" duration="5000"> </paper-toast>

    <paper-fab icon="help" on-tap="_seeHelp" style="float: right;"></paper-fab>

</div>
</template>

<script>
Polymer({
    is: "des-query",
    properties: {
        querystr :{
            type: String,
            observer: '_queryChanged',
        },
        querykind :{
            type: String,
            value: 'submit',
        },
        db :{
            type: String,
            value: '',
        },
        outputfile :{
            type: String,
            value: 'nofile',
        },
        jobid :{
            // current job id
            type: String,
            value: 'nojob',
        },
        queryname :{
            type: String,
            value: ''
        }
    },
    attached: function() {
        myQuery = document.getElementById("queryBox");
        setTimeout(function() {
            app.editor.refresh();
            app.editor.focus();
        },20);
    },
    ready: function (){

        var _self = this;
        loc = window.location.host;
        var ws = new WebSocket("ws://"+loc+"/easyweb/websocket/");
        ws.onmessage = function(e) {
            document.getElementById("getMyJobs").generateRequest();
            try {
                var tmp = JSON.parse(e.data);
                }
            catch(err) {
                return
            }
            _self.jobid = tmp.out;
            console.log(_self.jobid)
            document.getElementById("getMyResponse").generateRequest();
                _self.msg = tmp.result;
            }
    },
    _returnVal: function(item,key) {return item[key];},
    _getQuery: function(querystr,querykind,outputfile, queryname){return {query:querystr, querykind:querykind, filename:outputfile, queryname: queryname};},
    _getJobid: function(jobid){return {jobid:jobid};},
    _queryChanged: function(){
        console.log('query  changed to: ' , this.querystr);
    },
    _enableOutputFile: function(){
        if (document.getElementById('inputOutputCheck').checked){
            document.getElementById('inputOutputFile').disabled=false;
            document.getElementById('subQuery').disabled=false;
        }
        else {
            document.getElementById('inputOutputFile').disabled=true;
            document.getElementById('subQuery').disabled=true;
        }
    },
    _complete: function(e){
        var _self = this;
        document.getElementById("querySpinner").active = false;
        _self.data = e.detail.response;
        _self.isOk = true;
        if (_self.data.kind == 'select') {
            _self.isSelect = true;
            _self.isQuery = false;
            _self.mydata = JSON.parse(_self.data.data);
            _self.keys = Object.keys(_self.mydata[0]);
            _self.idx = "IDX";
        };
        if (_self.data.kind == 'query') {
            _self.isQuery = true;
            _self.isSelect = false;
            _self.msg = _self.data.data;
            _self.isOk = true;
            if (_self.data.status != 'ok') {_self.isOk = false;}
        };
        if (_self.data.kind == 'check') {
            _self.isQuery = true;
            _self.isSelect = false;
            _self.msg = _self.data.data;
            _self.isOk = true;
            if (_self.data.status != 'ok') {_self.isOk = false;}
        };
        var bbs = document.getElementsByClassName("queryButton");
        var cbbs = bbs.length;
        for (var i = 0; i< cbbs; i++){
            bbs[i].disabled = false;
        };
        if (this.querykind == 'submit') {
            if (_self.isOk){
            document.querySelector('#toast1').show();}
        }
        //document.querySelector('#toast1').show();
    },
    _request: function(e){
        var bbs = document.getElementsByClassName("queryButton");
        var cbbs = bbs.length;
        for (var i = 0; i< cbbs; i++){
            bbs[i].disabled = true;
        };

        if (this.querykind == 'quick') {
            document.getElementById("querySpinner").active = true;
        }
    },
    _error: function(e){
        document.querySelector('#toast2').show();
    },
    clearQueryBox: function(){
        this.querystr = '';
        app.editor.setValue('-- Insert Query --\n\n');
        app.editor.focus();
        app.editor.execCommand('goLineDown');
        document.getElementById('inputOutputFile').disabled = true;
        document.getElementById('inputOutputCheck').checked = false;
        document.getElementById('inputOutputFile').value = '';
        document.getElementById('queryname').value = '';
        document.getElementById('subQuery').disabled=true;
        this.outputfile = 'nofile';
        this.mydata = [];
        this.msg = '';
        this.keys = [];
        this.idx = '';
    },
    _submitQuery: function(event){
        this.querystr = app.editor.getValue();
        this.querykind = 'submit';
        this.queryname = document.getElementById('queryname').value;
        if (document.getElementById('inputOutputCheck').checked){
            this.outputfile = document.getElementById('inputOutputFile').value;}
        this.mydata = [];
        this.keys = [];
        this.idx = '';
        valid = true;
        if (this.querystr == '') {
            valid = false;
        }
        if (valid) {document.getElementById("getQuery").generateRequest();}
    },
    _quickSubmit: function(event){
        document.getElementById('inputOutputCheck').checked = false;
        document.getElementById('inputOutputFile').disabled = true;
        document.getElementById('subQuery').disabled=true;
        this.querystr = app.editor.getValue();
        this.querykind = 'quick';
        this.outputfile = 'nofile';
        this.queryname = document.getElementById('queryname').value;
        this.mydata = [];
        this.keys = [];
        this.idx = '';
        valid = true;
        if (this.querystr == '') {
            valid = false;
        }
        //var valid = document.getElementById("queryBox").validate();
        if (valid) {document.getElementById("getQuery").generateRequest();}
    },
    _checkSyntax: function(event){
        this.querystr = app.editor.getValue();
        this.querykind = 'check';
        this.queryname = document.getElementById('queryname').value;
        if (document.getElementById('inputOutputCheck').checked){
            this.outputfile = document.getElementById('inputOutputFile').value;
        }
        this.mydata = [];
        this.keys = [];
        this.idx = '';
        valid = true;
        if (this.querystr == '') {
            valid = false;
        }
        //var valid = document.getElementById("queryBox").validate();
        if (valid) {document.getElementById("getQuery").generateRequest();}
    },
    patchOverlay: function (e) {
        if (e.target.withBackdrop) {
            e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
        }
    },
    _seeHelp: function(e){
        e.preventDefault();
        document.getElementById('jobHelpQuery').open();
    },
});
</script>
</dom-module>
