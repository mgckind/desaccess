<dom-module id="des-coadds">
    <style include="shared-styles">
        .caption {
            padding-left: 15px;
            color: #a0a0a0;
        }
        .upload{
            position: absolute;
            opacity: 0;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
        .flex2 {
            @apply(--layout-vertical);
        }

        paper-slider {
            width: 80%;
        }
        hr {
            display: block;
            border: 1px solid gray;
            opacity: 0.2;

        }
    </style>
    <template>

        <section>
            <des-card heading = "Coadds Images Cutout Form" >
                <div class="card-content">
                    Upload the file with the positions or enter the positions by hand and run the desthumb generator
                </div>
                <div class="card-content">
                    <div class="horizontal layout around-justified" >
                        <paper-button raised  class="indigo"  id="uploadFile">
                            <div id ="uploadicon" style="display: inline-block;"> <i class="fa fa-cloud-upload"></i>
                                &nbsp;  &nbsp;
                            </div>
                            <span style="overflow-x: auto; overflow-wrap: break-word;">
                                [[file_name]]
                            </span>
                            <input type="file" class="upload" id="file" on-change="_fileChange"/>
                        </paper-button>

                        <paper-button raised  class="indigo" id="enterValues" on-tap="_openPositions">
                            <div id ="keyboardicon" style="display: inline-block;"> <i class="fa fa-keyboard-o"></i>
                                &nbsp;  &nbsp;
                            </div>
                            <span>[[enter_values]]</span>
                        </paper-button>
                    </div>

                    <hr>

                    <div>xsize (arcmin, if not selected default is from file or 1.0): <span id="xsizeLabel" class="caption">0</span></div><br>
                    <paper-slider id="xsizeSlider" pin  max="12" max-markers="10" step="0.1" value="0" expand></paper-slider>
                    <div>ysize (arcmin, if not selected default is from file or 1.0): <span id="ysizeLabel" class="caption">0</span></div><br>
                    <paper-slider id="ysizeSlider" pin  max="12" max-markers="10" step="0.1" value = "0" expand ></paper-slider>

                    <hr>

                    <paper-checkbox id="onlyreturnlist">Return just list of files (do not produce and display pngs, i.e. faster)</paper-checkbox>

                    <hr>

                    <div class="flex2" >
                        <paper-checkbox style="font-size:16px;" id="sendemail" on-change="emailcheck">Send me an email after job completion </paper-checkbox>
            &nbsp;  &nbsp;        <paper-input  id="validemail" name="email" label="Email" value=""></paper-input>
                        <br>
                    </div>

                    <div>

                        <paper-button raised class="indigo"  id="clearFormButton" on-tap="_clearForm">
                            <i class="fa fa-cogs"></i> &nbsp;  &nbsp;Clear Form
                        </paper-button>

                        <paper-button raised  class="indigo"  id="submitJobButton" disabled on-tap="_submitJob">
                        <i class="fa fa-cogs"></i> &nbsp;  &nbsp;Submit Job
                        </paper-button>
                    </div>
                </div>

            </des-card>

            <des-positions id="desPositions"></des-positions>

            <paper-toast class="toast-position" id="toast1" text="Job has been submitted!" duration="5000"> </paper-toast>
            <paper-toast class="toast-position" id="toast2" text="ERROR!. There was an error. Please try again" duration="5000"> </paper-toast>

            <paper-dialog class="size-position2" id="emaildialog" with-backdrop on-iron-overlay-opened="patchOverlay">
                <paper-card elevation="0">
                    <div class="card-content">
                        Please verify email address
                    </div>
                </paper-card>
            </paper-dialog>
        </section>
    </template>

</dom-module>

<script>

    Polymer({
        is: "des-coadds",
        properties: {
            file_name : {
                type : String,
                value : "Upload File"
            },
            enter_values : {
                type : String,
                value : "Enter Values"
            },
            submit_type : {
                type: String,
                value: "csvfile",
            },
            email: {
                type: String,
                values: "",
            },
            job_comment: {
                type : String,
                value : ""
            }
        },
        get file(){
            return this.$.file.files[0]
        },
        emailcheck: function(){
            var emailbox = document.getElementById("sendemail");
            var edialog = document.getElementById("emaildialog");
            document.getElementById("validemail").value=this.email;
            if (emailbox.checked == true){
                edialog.open();
            }
            else
            {
            document.getElementById("validemail").value='';
            }
        },
        _fileChange: function(){
            this.file_name = this.file.name;
            console.log('File to read : ' + this.file_name );
            document.getElementById("submitJobButton").disabled=false;
            document.getElementById("enterValues").disabled=true;
            document.getElementById("uploadicon").style.display='none';
            this.submit_type = 'csvfile';
        },
        clear: function(){
            document.getElementById("submitJobButton").disabled=true;
            document.getElementById("enterValues").disabled=false;
            document.getElementById("uploadFile").disabled=false;
            document.getElementById("keyboardicon").style.display='inline-block';
            document.getElementById("xsizeSlider").value="0.0";
            document.getElementById("ysizeSlider").value="0.0";
            document.getElementById("sendemail").checked=false;
            document.getElementById("onlyreturnlist").checked=false;
            document.getElementById("desPositions").clear();
            document.getElementById("validemail").value='';
//            document.getElementById("coaddTag").selected="0";
            this.file_name = "Upload File";
            this.job_comment = "";
//            document.getElementById("jobcommentcoadds").value="";

            var upIcon = document.getElementById("uploadicon").style.display='inline-block';
            this.enter_values = "Enter Values";
            //$('#dothis')[0].checked=false;
            this.$.file.value = "";
        },
        _openPositions: function(){
            var inputDialog = document.getElementById("inputValuesDialog");
            inputDialog.open();
            this.submit_type = 'manual';
        },
        completeHandler: function(){
            console.log('YESSSSS');
            document.getElementById('desCoadds').clear();
            //document.getElementById("getData").generateRequest();
            document.querySelector('#toast1').show();
//            document.querySelector('des-my-jobs').show();
            document.querySelector('des-my-jobs')._refreshJobs();


//            req = document.getElementById("getData");
//            req.generateRequest();
        },
        errorHandler: function(){
            console.log('NOOOO');
            document.getElementById('desCoadds').clear();
            document.querySelector('#toast2').show();
        },
        _submitJob: function(event){
            var formdata = new FormData();
            formdata.append('csvfile', this.$.file.files[0]);
            formdata.append('xsize', document.getElementById("xsizeSlider").value);
            formdata.append('ysize', document.getElementById("ysizeSlider").value);
            formdata.append('list_only', document.getElementById("onlyreturnlist").checked);
            formdata.append('send_email', document.getElementById("sendemail").checked);
            formdata.append('email', document.getElementById("validemail").value);
            formdata.append('submit_type', this.submit_type);
            formdata.append('values',document.getElementById("enteredPositions").value);

            $.ajax({
                url: '/easyweb/cutout/',
                type: 'POST',
                //beforeSend: this.beforeSendHandler,
                success: this.completeHandler,
                error: this.errorHandler,
                data: formdata,
                cache: false,
                contentType: false,
                processData: false
            });
        },
        _clearForm: function(){
            console.log('clear Form');
            desCoadds=document.getElementById('desCoadds');
            desCoadds.clear();
        },
         patchOverlay: function (e) {
             if (e.target.withBackdrop) {
                e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
             }
         },
    });



</script>
