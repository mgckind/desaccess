<dom-module id="des-epochs">

    <style include="shared-styles">

        paper-radio-button.myradio {
            --paper-radio-button-checked-color: var(--paper-blue-500);
            --paper-radio-button-checked-ink-color: var(--paper-blue-500);
            --paper-radio-button-unchecked-color: var(--paper-blue-900);
            --paper-radio-button-unchecked-ink-color: var(--paper-blue-900);
        }


        .caption {
            padding-left: 12px;
            color: #a0a0a0;
        }
        .upload{
            position: absolute;
            opacity: 0;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .card-content {
            @apply(--layout-vertical);
        }

        /*.middle {*/
        /*@apply(--layout-flex);*/
        /*}*/

        .epochs-container {
            margin-top: 10px;
            @apply(--layout-horizontal);
        }

        .container2 {
            @apply(--layout-horizontal);
            @apply(--layout-center-justified);
        }
        .container3 {
            @apply(--layout-horizontal);
            @apply(--layout-around-justified);
        }

        .left {
            @apply(--layout-flex);
        }
        .left2 {
            @apply(--layout-flex);
            text-align: center;

        }
        .right {
            @apply(--layout-flex);

        }

        .right2 {
            @apply(--layout-flex-2);
            text-align: center;

        }

        .mid {
            @apply(--layout-flex);
        }
        .flex3child {
            @apply(--layout-flex-3);
        }
        .flex4child {
            @apply(--layout-flex-4);
        }

        paper-slider {
            width: 100%;
        }

        hr {
            display: block;
            border: 1px solid gray;
            opacity: 0.2;

        }

        paper-icon-item {
            /*background: linear-gradient(to right, #efeaf4, white);*/
        }

        .buttonLook{
            border: 4px solid #ccc;
            border-style: outset;
            border-radius: 10px;
        }



        .btcell {
            text-align: center;
        }

        .around-cell {
            @apply(--layout-horizontal);
            @apply(--layout-around-justified);
        }

    </style>
    <template>
        <paper-dialog class="dialog-position" id="jobHelpS" with-backdrop on-iron-overlay-opened="patchOverlay">
            <des-card heading="Help">
                <div class="card-content">
                    <paper-carousel id="epochs-crs" items="1" dotText="false" controls="true">
                        <div class="carousel-item">
                            You can upload a csv file with positions or enter a list manually. The jobs is submitted asynchronously.
                            Check <b>My Jobs</b> tab to see the status of your jobs.
                        </div>

                        <div class="carousel-item">
                            <!--<div class="col">-->
                            <img src="/easyweb/static/images/demo1.gif" width="400px">

                            <div class="desc">
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                                Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                                Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                            </div>

                            <!--</div>-->
                        </div>

                        <div class="carousel-item">
                            <div class="row">
                                <div class="left">
                                    <img src="/easyweb/static/images/demo1.gif">
                                </div>

                                <div class="left">
                                    <img src="/easyweb/static/images/demo1.gif">
                                </div>

                                <div class="left">
                                    <img src="/easyweb/static/images/demo1.gif">
                                </div>
                            </div>
                            <div class="desc">
                                Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                                Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                                Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
                            </div>
                        </div>

                        <div class="carousel-item">
                            <img src="/easyweb/static/images/demo1.gif">
                            <div class="desc">
                                Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                                Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                            </div>
                        </div>

                    </paper-carousel>
                </div>
                <div class="row">
                    <paper-button class="prev" on-tap="_prevPage">
                        <iron-icon icon="image:navigate-before"></iron-icon>
                        Prev
                    </paper-button>

                    <paper-button class="next" on-tap="_nextPage">
                        Next
                        <iron-icon icon="image:navigate-next"></iron-icon>
                    </paper-button>
                </div>

            </des-card>
        </paper-dialog>
        <section>
            <des-card>
                <div class="card-content">
                    <div class="top">
                        Upload the file with the positions or enter the positions by hand and run the desthumb generator
                    </div>

                    <!-- table -->
                    <table id="epochs-table" style="width:100%">
                        <tr class="epochs-tr">
                            <td class="epochs-td">
                                <paper-icon-item>
                                    <iron-icon icon="backup" slot="item-icon"></iron-icon>
                                    <span style="overflow-x: auto; overflow-wrap: break-word;">
                                    Upload File (csv, with RA,DEC as uncommented header)
                                    </span>
                                    <!--<input type="file" class="upload" id="file" on-change="_fileChange"/>-->
                                </paper-icon-item>
                            </td>
                            <td class="btcell">
                                <paper-button raised class="indigo" id="uploadFileS">
                                    <div id ="uploadiconS" style="display: inline-block;">
                                        <i class="fa fa-cloud-upload"></i>
                                        &nbsp;  &nbsp;
                                    </div>
                                    <span style="overflow-x: auto; overflow-wrap: break-word;">
                                    [[file_name]]
                                </span>
                                    <input type="file" class="upload" id="fileS" on-change="_fileChange" />
                                </paper-button>
                            </td>
                        </tr>

                        <tr class="epochs-tr">
                            <td class="epochs-td">
                                <paper-icon-item>
                                    <iron-icon icon="hardware:keyboard" slot="item-icon"></iron-icon>
                                    Enter Values
                                </paper-icon-item>
                            </td>
                            <td class="btcell">
                                <paper-button raised  class="indigo" id="enterValuesS" on-tap="_openPositionsS">
                                    <div id ="keyboardiconS" style="display: inline-block;"> <i class="fa fa-keyboard-o"></i>
                                        &nbsp;  &nbsp;
                                    </div>
                                    <span>[[enter_values]]</span>
                                </paper-button>
                            </td>
                        </tr>

                        <tr class="epochs-tr">
                            <td class="epochs-td">
                                <paper-icon-item>
                                    <iron-icon icon="image:tune" slot="item-icon"></iron-icon>
                                    <div>Xsize (in arcminutes):
                                        <span id="xsizeLabelS" class="caption">1.0</span></div>
                                </paper-icon-item>
                            </td>
                            <td class="epochs-td">
                                <paper-slider id="xsizeSliderS" pin  max="12" max-markers="10" step="0.1" value="1.0" expand editable></paper-slider>
                            </td>
                        </tr>

                        <tr class="epochs-tr">
                            <td class="epochs-td">
                                <paper-icon-item>
                                    <iron-icon icon="image:tune" slot="item-icon"></iron-icon>
                                    <div>Ysize (in arcminutes):
                                        <span id="ysizeLabelS" class="caption">1.0</span></div>
                                </paper-icon-item>
                            </td>
                            <td class="epochs-td">
                                <paper-slider id="ysizeSliderS" pin  max="12" max-markers="10" step="0.1" value="1.0" expand editable></paper-slider>
                            </td>
                        </tr>

                        <tr class="epochs-tr">
                            <td class="epochs-td">
                                <paper-icon-item>
                                    <iron-icon icon="icons:filter-list" slot="item-icon"></iron-icon>
                                    Filter
                                </paper-icon-item>
                            </td>
                            <td class="epochs-td">
                                <div class="horizontal-layout">
                                    <paper-radio-button class="myradio" value="g" disabled><i>g</i></paper-radio-button>
                                    <paper-radio-button class="myradio" value="r" disabled><i>r</i></paper-radio-button>
                                    <paper-radio-button class="myradio" value="i" disabled><i>i</i></paper-radio-button>
                                    <paper-radio-button class="myradio" value="z" disabled><i>z</i></paper-radio-button>
                                    <paper-radio-button class="myradio" value="Y" disabled><i>Y</i></paper-radio-button>
                                    <paper-toggle-button id="all_toggle" checked>All filters</paper-toggle-button>
                                </div>
                            </td>
                        </tr>

                        <tr class="epochs-tr">
                            <td class="epochs-td">
                                <paper-icon-item>
                                    <iron-icon icon="image:filter-b-and-w" slot="item-icon"></iron-icon>
                                    Preprocess Picture
                                </paper-icon-item>
                            </td>
                            <td class="epochs-td">
                                <paper-checkbox id="blacklist">Exclude blacklisted ccds</paper-checkbox>
                            </td>
                        </tr>

                        <tr class="epochs-tr">
                            <td class="epochs-td">
                                <paper-icon-item>
                                    <iron-icon icon="create" slot="item-icon"></iron-icon>
                                    Job Name
                                </paper-icon-item>
                            </td>
                            <td class="epochs-td">
                                <paper-input always-float-label id="validnameS" name="name" label="Job Name" value="" style = "max-width: 500px;"></paper-input>
                            </td>
                        </tr>

                        <tr class="epochs-tr">
                            <td class="epochs-td">
                                <paper-icon-item>
                                    <iron-icon icon="mail" slot="item-icon"></iron-icon>
                                    Email Options
                                </paper-icon-item>
                            </td>
                            <td class="epochs-td">
                                <div class="around-cell">
                                    <div class="left">
                                        <paper-checkbox style="font-size:16px; padding-top:25px;" id="sendemailS" on-change="emailcheck">Send email on completion</paper-checkbox>
                                    </div>
                                    <div class="right">
                                        <paper-input always-float-label id="validemailS" name="email" label="Email" value="" ></paper-input>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <tr class="epochs-tr">
                            <td class="epochs-td">
                                <paper-icon-item>
                                    <iron-icon icon="save" slot="item-icon"></iron-icon>
                                    Return Type
                                </paper-icon-item>
                            </td>
                            <td class="epochs-td">
                                <paper-checkbox style="font-size:16px;" id="onlyreturnlistS">Return just list of files (do not produce and display pngs, i.e. faster)</paper-checkbox>
                            </td>
                        </tr>
                    </table>
                    <div class="epochs-container">
                        <div class="left">
                            <paper-button raised class="indigo"  id="clearFormButtonS" on-tap="_clearForm">
                                <i class="fa fa-cogs"></i> &nbsp;  &nbsp;Clear Form
                            </paper-button>
                        </div>
                        <div class="right">
                            <paper-button raised  class="indigo"  id="submitJobButtonS" disabled on-tap="_submitJob">
                                <i class="fa fa-cogs"></i> &nbsp;  &nbsp;Submit Job
                            </paper-button>
                        </div>
                    </div>
                </div>
            </des-card>

            <des-positions id="desPositionsS"></des-positions>

            <paper-toast class="toast-position" id="toast1epochsS" text="Job has been submitted!" duration="5000"> </paper-toast>
            <paper-toast class="toast-position" id="toast2epochsS" text="ERROR!. There was an error. Please try again" duration="5000"> </paper-toast>

            <paper-dialog class="size-position2" id="emaildialogS" with-backdrop on-iron-overlay-opened="patchOverlay">
                <paper-card elevation="0">
                    <div class="card-content">
                        Please verify email address
                    </div>
                </paper-card>
            </paper-dialog>
        </section>
        <paper-fab disabled class="fabHelp" icon="help" title="Help" on-tap="_seeHelp" style="float: right;"></paper-fab>

    </template>
</dom-module>

<script>

    Polymer({
        is: "des-epochs",
        properties: {
            file_name : {
                type : String,
                value : "Upload File"
            },
            enter_values : {
                type : String,
                value : "Enter Values"
            },
            submit_type : {
                type: String,
                value: "csvfile",
            },
            email: {
                type: String,
                values: "",
            },
        },

        ready:function(){
            var all_toggle= this.$.all_toggle;
            all_toggle.addEventListener('change', function(){
                // console.log(all_toggle.checked);
                document.getElementById('desEpochs').toggle_bands();
            });

        },
        toggle_bands:function(){
            var band_rads = document.querySelectorAll('.myradio');

            if (this.$.all_toggle.checked){
                for (var j=0; j < 5 ; j++){
                    band_rads[j].disabled=true;
                }
            }
            else{
                for (var i=0; i < 5 ; i++){
                    band_rads[i].disabled=false;
                }
            }

        },
        get file(){
            return this.$.fileS.files[0]
        },

        emailcheckS: function(){
            var emailbox = document.getElementById("sendemailS");
            var edialog = document.getElementById("emaildialogS");
            if (emailbox.checked == true){
                edialog.open();
            }
        },
        _fileChange: function(){
            this.file_name = this.file.name;
            console.log('File to read : ' + this.file_name );
            this.$.submitJobButtonS.disabled=false;
            this.$.enterValuesS.disabled=true;
            this.$.uploadiconS.style.display='none';
            this.submit_type = 'csvfile';
        },
        clear: function(){
            this.$.submitJobButtonS.disabled=true;
            this.$.enterValuesS.disabled=false;
            this.$.uploadFileS.disabled=false;
            this.$.keyboardiconS.style.display='inline-block';
            this.$.xsizeSliderS.value="0";
            this.$.ysizeSliderS.value="0";
            this.$.sendemailS.checked=false;
            this.$.onlyreturnlistS.checked=false;
            this.$.desPositionsS.clear();
            this.$.blacklist.checked=false;
            this.file_name = "Upload File";

            this.$.all_toggle.checked = true;

            var band_rads = document.querySelectorAll('.myradio');
            for (var j=0; j < 5 ; j++){
                band_rads[j].checked = false;
                band_rads[j].disabled=true;
            }

            var upIcon = this.$.uploadiconS.style.display='inline-block';
            this.enter_values = "Enter Values";
            //$('#dothis')[0].checked=false;
            this.$.fileS.value = "";


            document.getElementById("validemailS").value='';
            document.getElementById("validnameS").value='';
            document.getElementById("uploadiconS").icon = "backup";
            document.getElementById("keyboardiconS").icon = "hardware:keyboard";
        },

        _openPositionsS: function(){
            var inputDialog = document.getElementById("inputValuesDialogS");
            inputDialog.open();
            this.submit_type = 'manual';
        },

        completeHandler: function(){
            console.log('YESSSSS');
            document.getElementById('desEpochs').clear();
            document.getElementById("getData").generateRequest();
            document.querySelector('#toast1S').show();
            req = document.getElementById("getData");
            req.generateRequest();
        },

        errorHandler: function(){
            console.log('NOOOO');
            document.getElementById('desEpochs').clear();
            document.querySelector('#toast2S').show();
        },

        _getFilters:function(){
            var band_rads = document.querySelectorAll('.myradio');
            var bands = [];
            for (var z = 0; z < 5; z++){
                if (band_rads[z].checked){
                    bands.push(band_rads[z].value);
                }
            }
            console.log(bands);
            return bands;

        },
        _clearForm: function(){
            desEpochs=document.getElementById('desEpochs');
            desEpochs.clear();
        },
        
        _submitJob: function(event){
            console.log("reach this point")
            var formdata = new FormData();
            if (this.$.all_toggle.checked){
                formdata.append('bands', 'all');
            }
            else{
                var bands = this._getFilters();
                if (bands==[]){
                    // this.$.toast2S.text="Please select at least one filter, or you can toggle the all filters switch!";
                    this.errorHandler();
                }
                formdata.append('bands', bands);
            }
            console.log(formdata);
            formdata.append('csvfile', this.$.fileS.files[0]);
            formdata.append('xsize', document.getElementById("xsizeSliderS").value);
            formdata.append('ysize', document.getElementById("ysizeSliderS").value);
            formdata.append('list_only', document.getElementById("onlyreturnlistS").checked);
            formdata.append('send_email', document.getElementById("sendemailS").checked);
            formdata.append('email', document.getElementById("validemailS").value);
            formdata.append('submit_type', this.submit_type);
            formdata.append('values',document.getElementById("enteredPositionsS").value);
            formdata.append('noBlacklist', this.$.blacklist.checked);
            formdata.append('name', document.getElementById("validnameS").value);
            console.log('xsize');
            console.log(document.getElementById('xsizeSliderS').value);
            $.ajax({
                url: '/easyweb/cutout/epochs',
                type: 'POST',
                //beforeSend: this.beforeSendHandler,
                success: this.completeHandler,
                error: this.errorHandler,
                data: formdata,
                cache: false,
                contentType: false,
                processData: false
            });
        },

        patchOverlay: function (e) {
            if (e.target.withBackdrop) {
                e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
            }
        },
        _seeHelp: function(e){
            e.preventDefault();
            document.getElementById('jobHelpS').open();
        },


        _nextPage: function() {
            var crs = document.getElementById("epochs-crs");
            crs.goToNextPage();
        },

        _prevPage: function() {
            var crs = document.getElementById("epochs-crs");
            crs.goToPrevPage();
        },

    });


</script>