<dom-module id="des-finding-chart">
    <style include="shared-styles">
        .caption {
            padding-left: 15px;
            color: #a0a0a0;
        }
        .upload{
            position: absolute;
            opacity: 0;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            /*border: 2px dotted #8da6ce;*/
            /*border-style: outset;*/
        }
        .card-content {
            @apply(--layout-vertical);
        }
        /*.middle {*/
        /*@apply(--layout-flex);*/
        /*}*/
        .coadd-container {
            margin-top: 10px;
            @apply(--layout-horizontal);
        }
        .container2 {
            @apply(--layout-horizontal);
            @apply(--layout-center-justified);
        }
        .container3 {
            @apply(--layout-horizontal);
            @apply(--layout-around-justified);
        }
        .left {
            @apply(--layout-flex);
        }
        .left2 {
            @apply(--layout-flex);
            text-align: center;
        }
        .right {
            @apply(--layout-flex);

        }
        .right2 {
            @apply(--layout-flex-2);
            text-align: center;
        }
        .mid {
            @apply(--layout-flex);
        }
        .flex3child {
            @apply(--layout-flex-3);
        }
        .flex4child {
            @apply(--layout-flex-4);
        }
        paper-slider {
            width: 100%;
        }
        hr {
            display: block;
            border: 1px solid gray;
            opacity: 0.2;
        }
        paper-icon-item {
            /*background: linear-gradient(to right, #efeaf4, white);*/
        }
        .buttonLook{
            border: 4px solid #ccc;
            border-style: outset;
            border-radius: 10px;
        }
        .btcell {
            text-align: center;
        }
        .around-cell {
            @apply(--layout-horizontal);
            @apply(--layout-around-justified);
        }
    </style>
    <template>
        <paper-dialog class="dialog-position" id="jobHelpFindingChart" with-backdrop on-iron-overlay-opened="patchOverlay" style="max-width: 1000px; max-height: 800px;">
            <des-card heading="Finding Chart Help">
                <div class="card-content">
                    <paper-carousel id="fc-coadd-crs" items="1" dotText="false" controls="true">
                        <div class="carousel-item" style="text-align: left;">
                            <p>This form allows you to make a finding chart for a given position in any of the standard DES color bands in a PNG format image. The charts are based off the master FITS files for each tile of the DES footprint.</p>
                            
                            <p>The charts are annotated and highlight your object, the helper object (brightest object in the field of view), and the right ascension and declination changes (in arcseconds) between the two objects. The axes are labeled in DD:MM:SS (declination) and HH:MM:SS (right ascension).</p>
                            
                            <p>The accompanying objects.csv file lists up to 10 objects in the field that are brighter than your specified Magnitude Limit, in descending order of brightness. The first listed is the helper object selected. If your object is the brightest object in the field, a warning message will be shown in the log.log output file and no objects.csv file will be created.</p>
                            
                            <p><span style="font-weight:bold;">Why is there only one highlighted object in the finding chart?</span> This highlighted object is your object. The most likely reason for this is that your object is in fact the brightest object in the field of the cutout. You can try adjusting the magnitude limit slider and/or increasing the Xsize and Ysize of the cutout to include more objects in the field. There may be other noticeable objects in the field, but they are either dimmer than your object or have a missing magnitude data flag in the database.</p>
                        </div>
                        <div class="carousel-item" style="text-align: left;">
                            <p>You have the option to upload a CSV file of RA/DEC pairs or to enter a list manually.</p>
                            <div>
                                <img src="/easyweb/static/images/position_column_headers.png" style="width: 200px; float: right; border: 1px #000 solid; margin:5px;" />
                                <p><span style="font-weight:bold;">Upload File:</span> If you upload a CSV, you must include the columns headers "RA,DEC" (without quotation marks). Example is shown at right.</p>
                            </div>
                            <div style="clear:right;">
                                <img src="/easyweb/static/images/manual_positions.png" style="width: 400px; float: right; border: 1px #000 solid; margin:5px;" />
                                <p><span style="font-weight:bold;">Enter Values:</span> Otherwise you can enter a list of RA/DEC pairs manually. You do not need to include the column headers here.</p>
                            </div>
                        </div>
                        <div class="carousel-item" style="text-align: left;">
                            <p><span style="font-weight:bold;">Xsize, Ysize:</span> You can use the Xsize and Ysize sliders to adjust how large the field around your object is, with your object centered in the field. This is measured in arcminutes. The size of the field may affect which object is selected as the helper object, or if one is found at all. Ranges 0-12 arcminutes in 0.1 increments. A size of 0 defaults to 1 arcminute.</p>
                            
                            <p><span style="font-weight:bold;">Filter Band:</span> You can choose between any or all DES color bands (<span style="font-style:italic;">g, r, i, z, Y</span>). Some objects are brighter in different bands and the helper object may not be the same across bands. If no bands are selected when you submit the job, a message will pop up at the lower left of the screen that says, "Form is incomplete for selected options!"</p>
                            
                            <p><span style="font-weight:bold;">Magnitude Limit:</span> The Magnitude Limit slider lets you specify how dim your helper object is allowed to be. Ranges 14-26 magnitude.</p>
                            
                            <p><span style="font-weight:bold;">Job Name:</span> The Job Name is for your records and does not affect the completion of the job.</p>
                            
                            <p><span style="font-weight:bold;">Email Options:</span> If you wish, the server can send an email notification when the job is completed. Check "Send email on completion" and verify the email you wish the notification to be sent to.</p>
                            
                            <p><span style="font-weight:bold;">Return Options:</span> Finally, the finding charts are all based on cutouts of the FITS master files of each DES tile. These cutouts are always created, but if you select "Include cutout with chart," a list_all.json file with URLs to the FITS cutouts will be generated to accompany the list.json file.</p>
                        </div>
                        <div class="carousel-item">
                            <div style="text-align: left;"><p>Example finding chart:</p></div>
                            <img src="/easyweb/static/images/DESJ004034.0-620158.6_I.png" style="width:100%; max-width:500px; margin: 0 auto; border: 1px #000 solid;" />
                        </div>
                    </paper-carousel>
                </div>
                <div class="row">
                    <paper-button class="prev" on-tap="_prevPage"><iron-icon icon="image:navigate-before"></iron-icon>Prev</paper-button>
                    <paper-button class="next" on-tap="_nextPage">Next<iron-icon icon="image:navigate-next"></iron-icon></paper-button>
                </div>
                <div class="row">
                    <paper-button class="indigo" on-tap="_gobackdialog" raised focused>Close</paper-button>
                </div>
            </des-card>
        </paper-dialog>
        <section>
            <des-card heading="Finding Chart Form">
                <div class="card-content">
                    <div class="top">
                        Upload the file with the positions or enter the positions by hand and run the desthumb generator
                    </div>

                    <!-- table -->
                    <table id="coadd-table" style="width:100%">
                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="backup" slot="item-icon"></iron-icon>
                                    <span style="overflow-x: auto; overflow-wrap: break-word;">
                                    Upload File (csv, with RA,DEC as uncommented header)
                                    </span>
                                    <!--<input type="file" class="upload" id="file" on-change="_fileChange"/>-->
                                </paper-icon-item>
                            </td>
                            <td class="btcell">
                                <paper-button raised class="indigo" id="fc_uploadFile">
                                    <div id="fc_uploadicon" style="display: inline-block;">
                                        <i class="fa fa-cloud-upload"></i>
                                        &nbsp;  &nbsp;
                                    </div>
                                    <span style="overflow-x: auto; overflow-wrap: break-word;">
										[[file_name]]
									</span>
                                    <input type="file" class="upload" id="file" on-change="_fileChange" />
                                </paper-button>
                            </td>
                        </tr>

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="hardware:keyboard" slot="item-icon"></iron-icon>
                                    Enter Values
                                </paper-icon-item>
                            </td>
                            <td class="btcell">
                                <paper-button raised class="indigo" id="fc_enterValues" on-tap="_fc_openPositions">
                                    <div id ="fc_keyboardicon" style="display: inline-block;"> <i class="fa fa-keyboard-o"></i>
                                        &nbsp;  &nbsp;
                                    </div>
                                    <span>[[enter_values]]</span>
                                </paper-button>
                            </td>
                        </tr>

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="image:tune" slot="item-icon"></iron-icon>
                                    <div>Xsize (in arcminutes):
                                        <span id="fc_xsizeLabel" class="caption">1.0</span></div>
                                </paper-icon-item>
                            </td>
                            <td class="coadd-td">
                                <paper-slider id="fc_xsizeSlider" pin max="12" max-markers="10" step="0.1" value="1.0" expand editable></paper-slider>
                            </td>
                        </tr>

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="image:tune" slot="item-icon"></iron-icon>
                                    <div>Ysize (in arcminutes):
                                        <span id="fc_ysizeLabel" class="caption">1.0</span></div>
                                </paper-icon-item>
                            </td>
                            <td class="coadd-td">
                                <paper-slider id="fc_ysizeSlider" pin  max="12" max-markers="10" step="0.1" value="1.0" expand editable></paper-slider>
                            </td>
                        </tr>
                        
                        <tr class="coadd-tr">
							<td class="coadd-td">
								<paper-icon-item>
									<iron-icon icon="image:tune" slot="item-icon"></iron-icon>
									Filter Band (default i band)
								</paper-icon-item>
							</td>
							<td class="coadd-td">
								<div class="around-cell">
									<paper-checkbox class="bandbox" style="font-size:16px; padding-top:15px;" id="fc_gband">g</paper-checkbox>
									<paper-checkbox class="bandbox" style="font-size:16px; padding-top:15px;" id="fc_rband">r</paper-checkbox>
									<paper-checkbox class="bandbox" checked style="font-size:16px; padding-top:15px;" id="fc_iband">i</paper-checkbox>
									<paper-checkbox class="bandbox" style="font-size:16px; padding-top:15px;" id="fc_zband">z</paper-checkbox>
									<paper-checkbox class="bandbox" style="font-size:16px; padding-top:15px;" id="fc_Yband">Y</paper-checkbox>
                                    <paper-toggle-button style="font-size:16px; padding-top:15px;" id="fc_all_toggle">Select All</paper-toggle-button>
								</div>
							</td>
                        </tr>
                        
                        <tr class="coadd-tr">
							<td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="image:tune" slot="item-icon"></iron-icon>
                                    <div>Magnitude Limit (dimmest allowed helper object):
                                        <span id="fc_magLabel" class="caption">20.0</span></div>
                                </paper-icon-item>
                            </td>
							<td class="coadd-td">
                                <paper-slider id="fc_magSlider" pin min="14" max="26" max-markers="10" step="0.1" value="20.0" expand editable></paper-slider>
                            </td>
                        </tr>

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="create" slot="item-icon"></iron-icon>
                                    Job Name
                                </paper-icon-item>
                            </td>
                            <td class="coadd-td">
                                <paper-input always-float-label id="fc_validname" name="name" label="Job Name" value="" style = "max-width: 500px;"></paper-input>
                            </td>
                        </tr>

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="mail" slot="item-icon"></iron-icon>
                                    Email Options
                                </paper-icon-item>
                            </td>
                            <td class="coadd-td">
                                <div class="around-cell">
                                    <div class="left">
                                        <paper-checkbox style="font-size:16px; padding-top:25px;" id="fc_sendemail" on-change="emailcheck">Send email on completion</paper-checkbox>
                                    </div>
                                    <div class="right">
                                        <paper-input always-float-label id="fc_validemail" name="email" label="Email" value="" ></paper-input>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <tr class="coadd-tr">
                            <td class="coadd-td">
                                <paper-icon-item>
                                    <iron-icon icon="save" slot="item-icon"></iron-icon>
                                    Return Options
                                </paper-icon-item>
                            </td>
                            <td class="coadd-td">
                                <paper-checkbox style="font-size:16px;" id="fc_returnCutoutPng">Include cutout with chart</paper-checkbox>
                            </td>
                        </tr>
                    </table>
                    <div class="coadd-container">
                        <div class="left">
                            <paper-button raised class="indigo"  id="clearFormButton" on-tap="_clearForm">
                            <i class="fa fa-cogs"></i> &nbsp;  &nbsp;Clear Form
                            </paper-button>
                            </div>
                        <div class="right">
                            <paper-button raised  class="indigo"  id="fc_submitJobButton" disabled on-tap="_submitJob">
                            <i class="fa fa-cogs"></i> &nbsp;  &nbsp;Submit Job
                            </paper-button>
                        </div>
                    </div>
                </div>
            </des-card>

            <des-positions-fc id="desPositionsFC"></des-positions-fc>

            <paper-toast class="toast-position" id="fc_toast1coadd" text="Job has been submitted!" duration="5000"> </paper-toast>
            <paper-toast class="toast-position" id="fc_toast2coadd" text="ERROR!. There was an error. Please try again" duration="5000"> </paper-toast>

            <paper-dialog class="size-position2" id="fc_emaildialog" with-backdrop on-iron-overlay-opened="patchOverlay">
                <paper-card elevation="0">
                    <div class="card-content">
                        Please verify email address
                    </div>
                </paper-card>
            </paper-dialog>
        </section>
        <paper-fab class="fabHelp" icon="help" title="Help" on-tap="_seeHelp" style="float: right;"></paper-fab>
    </template>
</dom-module>

<script>
    Polymer({
        is: "des-finding-chart",
        properties: {
            file_name : {
                type : String,
                value : "Upload File"
            },
            enter_values : {
                type : String,
                value : "Enter Values"
            },

            submit_type : {
                type: String,
                value: "csvfile",
            },
            email: {
                type: String,
                values: "",
            },
            job_comment: {
                type : String,
                value : ""
            }
        },
        
        ready:function(){
            var fc_all_toggle = this.$.fc_all_toggle;
            fc_all_toggle.addEventListener('change', function(){
                document.getElementById('desFindingChart').toggle_bands();
            });
        },
        
        toggle_bands:function(){
            var band_rads = document.querySelectorAll('.bandbox');
            if (this.$.fc_all_toggle.checked){
                for (var j=0; j<5; j++){
                    band_rads[j].disabled=true;
                }
            }
            else{
                for (var i=0; i<5; i++){
                    band_rads[i].disabled=false;
                }
            }
        },
        
        get file(){
            return this.$.file.files[0]
        },
        
        emailcheck: function(){
            var emailbox = document.getElementById("fc_sendemail");
            var edialog = document.getElementById("fc_emaildialog");
            document.getElementById("fc_validemail").value=this.email;
            if (emailbox.checked == true){
                //edialog.open();
            }
            else
            {
                document.getElementById("fc_validemail").value='';
            }
        },
        
        _fileChange: function(){
            this.file_name = this.file.name;
            console.log('File to read : ' + this.file_name );
            document.getElementById("fc_submitJobButton").disabled=false;
            document.getElementById("fc_enterValues").disabled=true;
//            document.getElementById("fc_uploadicon").style.display='none';
            document.getElementById("fc_uploadicon").icon = "done";

            this.submit_type = 'csvfile';
//            document.getElementById("filename").value = this.file_name;
        },
        
        clear: function(){
            document.getElementById("fc_submitJobButton").disabled=true;
            document.getElementById("fc_enterValues").disabled=false;
            document.getElementById("fc_uploadFile").disabled=false;
            document.getElementById("fc_keyboardicon").style.display='inline-block';
            document.getElementById("fc_xsizeSlider").value="1.0";
            document.getElementById("fc_ysizeSlider").value="1.0";
            document.getElementById("fc_xsizeLabel").innerHTML="1.0";
            document.getElementById("fc_ysizeLabel").innerHTML="1.0";
            document.getElementById("fc_all_toggle").checked=false;
            
            var band_rads = document.querySelectorAll('.bandbox');
            for (var j=0; j<5; j++){
                band_rads[j].checked=false;
                band_rads[j].disabled=false;
            }
            
            document.getElementById("fc_gband").checked=false;
            document.getElementById("fc_rband").checked=false;
            document.getElementById("fc_iband").checked=true;
            document.getElementById("fc_zband").checked=false;
            document.getElementById("fc_Yband").checked=false;
            document.getElementById("fc_magSlider").value="20.0";
            document.getElementById("fc_magLabel").innerHTML="20.0";
            document.getElementById("fc_sendemail").checked=false;
            document.getElementById("fc_returnCutoutPng").checked=false;
            document.getElementById("desPositionsFC").clear();
            document.getElementById("fc_validemail").value='';
            document.getElementById("fc_validname").value='';
//            document.getElementById("filename").value = '';
//            document.getElementById("coords").value = '';
            document.getElementById("fc_uploadicon").icon = "backup";
            document.getElementById("fc_keyboardicon").icon = "hardware:keyboard";
//            document.getElementById("coaddTag").selected="0";
            this.file_name = "Upload File";
            this.job_comment = "";
//            document.getElementById("jobcommentcoadds").value="";

            var upIcon = document.getElementById("fc_uploadicon").style.display='inline-block';
            this.enter_values = "Enter Values";
            //$('#dothis')[0].checked=false;
            this.$.file.value = "";
        },
        
        _countCoords: function(coords) {
            console.log(coords);
        },

        _fc_openPositions: function(){
            var inputDialog = document.getElementById("fc_inputValuesDialog");
            inputDialog.open();
            this.submit_type = 'manual';
        },
        
        completeHandler: function(){
            console.log('YESSSSS');
            document.getElementById('desFindingChart').clear();
            document.querySelector('#fc_toast1coadd').show();
            document.getElementById("getMyJobs").generateRequest();
        },
        
        errorHandler: function(){
            console.log('NOOOO');
            document.getElementById('desFindingChart').clear();
            document.querySelector('#fc_toast2coadd').show();
        },
        
        _submitJob: function(event){
            var formdata = new FormData();
            formdata.append('csvfile', this.$.file.files[0]);
            formdata.append('fc_xsize', document.getElementById("fc_xsizeSlider").value);
            formdata.append('fc_ysize', document.getElementById("fc_ysizeSlider").value);
            formdata.append('fc_gband', document.getElementById("fc_gband").checked);
            formdata.append('fc_rband', document.getElementById("fc_rband").checked);
            formdata.append('fc_iband', document.getElementById("fc_iband").checked);
            formdata.append('fc_zband', document.getElementById("fc_zband").checked);
            formdata.append('fc_yband', document.getElementById("fc_Yband").checked);
            formdata.append('fc_mag', document.getElementById("fc_magSlider").value);
            formdata.append('return_cutout_png', document.getElementById("fc_returnCutoutPng").checked);
            formdata.append('fc_send_email', document.getElementById("fc_sendemail").checked);
            formdata.append('fc_email', document.getElementById("fc_validemail").value);
            formdata.append('fc_name', document.getElementById("fc_validname").value);
            formdata.append('fc_submit_type', this.submit_type);
            formdata.append('fc_values',document.getElementById("fc_enteredPositions").value);
            formdata.append('fc_all_toggle', document.getElementById("fc_all_toggle").checked);

            $.ajax({
                url: '/easyweb/dr1_chart/',
                type: 'POST',
                //beforeSend: this.beforeSendHandler,
                success: this.completeHandler,
                error: this.errorHandler,
                data: formdata,
                cache: false,
                contentType: false,
                processData: false
            });
        },
        
        _clearForm: function(){
            console.log('clear Form');
            desFindingChart=document.getElementById('desFindingChart');
            desFindingChart.clear();
        },
        
        patchOverlay: function (e) {
            if (e.target.withBackdrop) {
                e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
            }
        },
        
        _seeHelp: function(e){
            e.preventDefault();
            document.getElementById('jobHelpFindingChart').open();
        },

        _nextPage: function() {
            var crs = document.getElementById("fc-coadd-crs");
            crs.goToNextPage();
        },

        _prevPage: function() {
            var crs = document.getElementById("fc-coadd-crs");
            crs.goToPrevPage();
        },
        _gobackdialog: function(event){
            document.getElementById('jobHelpFindingChart').close();
        },
    });
</script>
