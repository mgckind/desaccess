<dom-module id="des-thumb">
    <style include="shared-styles">
        :host {
            display: block;
            height : 240px; // 220px;
            width: 240px; // 220px;
            margin: 10px;
            float : left;
            background-color: white;
        }


        paper-card {
            width: 200px;
            height: 200px;
            margin-bottom: 0px;
        }
        .mycard{
            width: 200px;
            height: 220px; // 200px;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 0px;
            font-size: 15px;
            color : var(--paper-pink-500);
        }
        .mycard:hover {
            @apply(--shadow-elevation-16dp);
            visibility: visible;
        }

        .mycard:hover .mycolors{
            visibility: visible;
        }
        .pink {
            --paper-card-header-color: var(--paper-green-500);
        }
        .thumb{
            height: 300px;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            padding: 10px;
        }
        .thumb:hover .mycolors{
            visibility: visible;
        }
        .mycolors{
            color: pink;
            visibility: hidden;
        }

        .mycolors:hover{
            color:green;
        }
        paper-dialog {
            position: fixed;
            max-width: 90%;
            top: 16px;
        }
        paper-spinner.big {
            width: 60px;
            height:60px;
            position: absolute;
            top: 70px;
            left: 70px;
        }
        paper-dialog.centered {
            position: fixed;
            top: 20px;
            left: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }

    </style>

    <template>
        <!--<paper-material class="thumb" elevation="[[_elevation]]" on-mouseover="_mouseover" on-mouseout="_mouseout" on-click="openBig">-->
            <div class="mycard" on-click="openBig"> <div style="position:absolute;">
                <span style="font-size: 8px; font-family: monospace; ">{{imtitle}}</span> </div>
                <paper-spinner class="big" ></paper-spinner>
                <img src={{imdisplay}} style="position:relative; top:20px; height:200px; width:200px; object-fit:cover;" />
                <!--<div style="position:relative; left:-8px; top:-32px;">-->
                <div style="position:relative; left:-8px; top:-12px;">
                      <paper-icon-button id="infoid" icon="info" class="mycolors">
                      </paper-icon-button>
                </div>
            </div>
        <!--</paper-material>-->

        <!-- DIALOG -->
        <paper-dialog  id="SingleTileDialog" class="centered"  with-backdrop modal on-iron-overlay-opened="patchOverlay" style="max-width:698px; height:auto; max-height: 800px;">
            <h3 id="SingleTileTitle">{{imtitle}}</h3>
            <img id="SingleTileImg" style="max-width: 650px; height:auto; max-height: 750px;" />
            <div class="buttons horizontal layout left-justified">
                  <paper-button class="indigo" on-tap="_gobackdialog" raised focused>Close</paper-button>
                  <paper-button class="indigo" raised on-tap="download"> Download</paper-button>
            </div>
            <span style="font-size: 9px;"> *Image is displayed to fit the screen, original might be larger</span>
        </paper-dialog>
    </template>

    <script>
        var singlepath = "";
        var singletitle = "";
        (function(){
            Polymer({
                is: "des-thumb",
                behaviors: [
                    Polymer.IronA11yKeysBehavior
                ],
                properties: {
                    _elevation:{
                        type: Number,
                        value: 0,
                    },
                    imdisplay:{
                        type: String,
                        value: "",
                    },
                    imtitle:{
                        type: String,
                        value: "",
                    },
                    jobid : {
                        type: String,
                    },
                },
                keyBindings:{
                    'enter:keydown':'_gobackdialog',
                },

                _nextPage: function() {
                    var crs = document.getElementById("thumb-crs");
                    crs.goToNextPage();
                },

                _prevPage: function() {
                    var crs = document.getElementById("thumb-crs");
                    crs.goToPrevPage();
                },

                _mouseout: function(){
                    this._elevation = 0;
                },

                _mouseover: function(){
                    this._elevation = 5;
                },

                openBig: function(event){
                    document.getElementById('SingleTileImg').src=this.imdisplay;
                    document.getElementById('SingleTileTitle').innerHTML=this.imtitle;
                    document.getElementById('SingleTileDialog').open();
                },

                _gobackdialog: function(event){
                    document.getElementById('SingleTileDialog').close();
                    document.getElementById('JobTiles').close();
                    document.getElementById('JobTiles').open();
                },

                completeHandler: function(){
                    var link = document.createElement('a');
                    var pathL = singlepath.replace('.tif.png','.tar.gz');
                    link.href = pathL; //pathL.replace(".tif.png",".tar.gz");
                    console.log('REFP', link.href);

                    if (link.download !== undefined){
                        //Set HTML5 download attribute. This will prevent file from opening if supported.
                        var fileName = pathL.substring(pathL.lastIndexOf('/') + 1, pathL.length);
                        console.log("==>FILENAME: ", fileName);
                        link.download = fileName;
                    }
                    if (document.createEvent) {
                        var e = document.createEvent('MouseEvents');
                        e.initEvent('click' ,true ,true);
                        link.dispatchEvent(e);
                        return true;
                    }
                    var query = '?download';
                    window.open(pathL + query);
                    //window.open(this.imdisplay,'_self');
                },

                errorHandler: function(){
                    console.log('Oh no!');
                },

                patchOverlay: function (e) {
                    if (e.target.withBackdrop) {
                        e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
                    }
                },

                _seeHelp: function(e){
                    e.preventDefault();
                    document.getElementById('jobHelpThumb').open();
                },

                download: function(event){
                    var siid = this.jobid;
                    console.log(siid);
                    event.stopPropagation();
                    var data = new FormData();
                    singlepath = document.getElementById('SingleTileImg').src;
                    singletitle = document.getElementById('SingleTileTitle').innerHTML;
                    data.append('title', singletitle);
                    data.append('jobid', siid);
                    data.append('path', singlepath);

                    $.ajax({
                        url: '/easyweb/download/coadd/object/',  //Server script to process data
                        type: 'POST',
                        data: data,
                        success: this.completeHandler,
                        error: this.errorHandler,
                        //Options to tell jQuery not to process data or worry about content-type.
                        cache: false,
                        contentType: false,
                        processData: false
                    });
                },

            });
        })();
    </script>

</dom-module>
