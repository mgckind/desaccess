<dom-module id="des-login-signup">
<template>
  <style include="shared-styles">
  </style>


<iron-ajax id="SignupForm"
    url="/easyweb/signup/"
    method="POST"
    handle-as="json"
    content-type="application/x-www-form-urlencoded"
    on-response="afterForm"
    debounce-duration="300">
</iron-ajax>


<paper-dialog class="tos-dialog" id="TermsDialog" modal>
  <h2>Terms of Service</h2>
  <p> Welcome to the DESaccess website. <br />
      NCSA provides website applications and other products and servces to access DES public data, use product
      or services.
      NCSA provides the Services subject to the following conditions: <br />
      <br />
      <b>Abuse:</b><br />
      <b>Use:</b><br />
      <b>Data Expiration:</b><br />
      <b>Termination:</b><br />
      <b>Acknoledgements:</b>

  </p>
    <div class="buttons">
  <paper-button class="custom indigo" dialog-confirm autofocus>Close</paper-button>

</div>
</paper-dialog>

    <template is="dom-if" if="{{msg}}">
        <des-login-message title='Thanks!'>
            <b> Activation Required:</b> {{text}} <br /> <br />
            Please check your email and use the activation link provided.<br /><br />
        </des-login-message>
    </template>

    <template is="dom-if" if="{{!msg}}">


  <div style="cursor:default;" class="container">
    <!-- https://elements.polymer-project.org/guides/flex-layout -->
    <paper-card style="cursor:default;" heading="Registration form" class="temp">

      <div style="cursor:default;" class="box-watermark-logo"></div>

      <div class="card-content">

        <span>Please complete and submit this form. <br />

        <span> Fill this <a href='http://desmaster.ncsa.illinois.edu/help' target="_blank">form</a>
             if you have trouble accessing the server</span><br /><br />
            You need to read and accept the <a href="javascript:;" on-click="_readT">Terms of Service</a> to continue.</span><br>

         <iron-form id="signUser">
         <form action="/easyweb/signup/" method="post">
          <div class="container2">
          <paper-input id="form_first" name="firstname" label="First" ></paper-input> &nbsp; &nbsp;
          <paper-input id="form_last" name="lastname" label="Last" ></paper-input>
          </div>
          <paper-input id="form_email" name="email" label="Email" on-change="_enable" required auto-validate></paper-input><br>
          <paper-input  id="form_user" name="username" label="Username" on-change="_enable" required auto-validate pattern="[a-zA-Z0-9]*" char-counter minlength="3" error-message="Minimum length is 3. Include alphanumeric characters only" ></paper-input><br>

          <match-passwords-validator id="match-passwords-validator"
            password="[[password]]">
          </match-passwords-validator>
          <paper-password-input id="first_password" label="Password (at least 6 characters)"
            value="{{password}}"
            char-counter
             required>
          </paper-password-input>
          <paper-password-input id="form_password" on-invalid-changed="_enable" id="NewPass" name="password" label="Confirm Password"
            auto-validate
            validator="match-passwords-validator"
            error-message="Passwords need to match"
            required>
          </paper-password-input>
          <br>
          <paper-checkbox id="readTerms" name="read" on-change="_enable" required>I agree to the </paper-checkbox> <a href="javascript:;" on-click="_readT">Terms of Service</a><br>
          <div class="container">
            <paper-spinner style="position: fixed; z-index:1000;" id="LoginSpinnerSignup" class="big"></paper-spinner>
            <paper-button class="custom indigo" id="SignButton"
            on-tap="_clickSubmit" raised disabled>
              Submit
            </paper-button>
          </div>

        </form>
        </iron-form>

        <div id="divError2" class="errormessage">
          <b>{{error}}</b>
        </div>
      </div>

      <div  style="cursor:pointer;" on-tap="home" class="box-upper-image"></div> <!-- TODO: ADD link to home page to the box -->


    </paper-card>
  </div>
    </template>
<paper-toast class="toast-position" id="toastSignUp" text="Form Submitted!" duration="2000"> </paper-toast>
</template>

<script>
  Polymer({
    is: "des-login-signup",

    behaviors: [
      Polymer.IronA11yKeysBehavior
    ],

    properties : {
      error :{
        type: String,
        value: '',
      },
      errno :{
        type: String,
        value: '',
      },
      text :{
        type: String,
        value: '',
      },
      msg:{
        type: Boolean,
        value: false,
      },
      toastpass: {
        type: String,
        value: false,
        //observer: "_updateToast"
    },
    },

    keyBindings:{
      'enter:keydown':'_clickSubmit',
    },

    _readT: function(){
            termd = document.getElementById('TermsDialog');
            termd.open();
    },
      _enable: function(e){
          //this.msg = true;
          var form = document.getElementById('signUser');
          var valid_form = form.validate();
          var invalid = true;
          var button = document.getElementById('SignButton');
          if (valid_form) {
              button.disabled = false;
                }
            else button.disabled = true;
           },
    _clickSubmit: function(e) {
      var button = document.getElementById('SignButton');
      var form2 = document.getElementById('SignupForm');
      form2.body = {
          'username': document.getElementById('form_user').value,
          'firstname': document.getElementById('form_first').value,
          'lastname': document.getElementById('form_last').value,
          'password': document.getElementById('form_password').value,
          'email': document.getElementById('form_email').value,
      };
      var form = document.getElementById('signUser');
      var valid_form = form.validate();
      if (valid_form) {
        button.disabled = true;
        document.getElementById('LoginSpinnerSignup').active = true;
        form2.generateRequest();
        document.getElementById("toastSignUp").show();
       }
    },
    afterForm: function(e){

     var _self = this;
     _self.data = e.detail.response;
     document.getElementById('readTerms').checked= false;
     this._enable();
     document.getElementById('LoginSpinnerSignup').active = false;
     //document.getElementById("toastSignUp").show();
     this.error = _self.data.msg;
     this.errno = _self.data.errno;
     console.log(this.error);
     if (this.errno=='1') {
         document.getElementById('form_user').value = '';
     }
     else if (this.errno=='2') {
         document.getElementById('form_email').value = '';
     }
     else if (this.errno=='3') {
         document.getElementById('form_password').value = '';
     }
     else {
         var email = document.getElementById('form_email').value;
         this.text = 'An activation link was sent to '+ email + '.';
         this.msg=  true;
         //msgReq = document.getElementById('Message');
         //msgReq.body = {
          //'title': 'Activation link sent by email',
         //};
        //msgReq.generateRequest();
      }

    },
    _updateToast: function(e) {
      if (this.toastpass=='yes'){
        document.getElementById("toastSignUp").show();
      }
  },
      home: function(event){
        window.open('/easyweb/','_self',false);
      },

  });


</script>
</dom-module>
